<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹è¡¨è½¬æ¢å‘å¯¼ - ç´¢å¼•ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        .step-active { @apply border-blue-500 text-blue-600; }
        .step-inactive { @apply border-gray-200 text-gray-400; }
        .table-cell { @apply border px-2 py-1 text-xs whitespace-nowrap overflow-hidden text-ellipsis max-w-[150px]; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">
    <div id="app" class="flex flex-col h-full">
        
        <header class="bg-white shadow px-6 py-4 z-10">
            <h1 class="text-xl font-bold text-gray-800">â›´ï¸ èˆ¹èˆ¶ç‚¹è¡¨äº¤äº’å¼è½¬æ¢å‘å¯¼ (Index Mode)</h1>
            <div class="flex mt-4 space-x-8 text-sm font-medium">
                <div :class="step >= 1 ? 'text-blue-600' : 'text-gray-400'">1. ä¸Šä¼ æ–‡ä»¶</div>
                <div :class="step >= 2 ? 'text-blue-600' : 'text-gray-400'">2. é€‰æ‹© Sheet & è¡¨å¤´</div>
                <div :class="step >= 3 ? 'text-blue-600' : 'text-gray-400'">3. å»ºç«‹æ˜ å°„</div>
                <div :class="step >= 4 ? 'text-blue-600' : 'text-gray-400'">4. ç»“æœå¯¹æ¯”</div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative">
            <!-- Step 1: ä¸Šä¼  -->
            <div v-if="step === 1" class="flex items-center justify-center h-full">
                <div class="bg-white p-10 rounded-xl shadow-lg text-center">
                    <input type="file" @change="uploadFile" class="block w-full text-sm text-slate-500"/>
                </div>
            </div>

            <!-- Step 2: é€‰æ‹©è¡¨å¤´ -->
            <div v-if="step === 2" class="flex flex-col h-full p-6">
                <div class="flex space-x-2 mb-4 overflow-x-auto pb-2">
                    <button v-for="s in sheets" :key="s" @click="selectSheet(s)"
                        :class="['px-4 py-2 rounded-lg text-sm', currentSheet === s ? 'bg-blue-600 text-white' : 'bg-white hover:bg-gray-100']">
                        [[ s ]]
                    </button>
                </div>
                <div class="flex-1 overflow-auto bg-white rounded shadow border relative">
                    <table class="w-full">
                        <thead class="sticky top-0 bg-gray-200 z-20">
                            <tr>
                                <th class="w-10 text-xs p-1 border">#</th>
                                <th v-for="n in maxCols" :key="n" class="text-xs p-1 border text-center font-mono text-gray-500">
                                    [[ getExcelColumnName(n-1) ]]
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(row, rIdx) in rawPreviewRows" :key="rIdx" @click="selectHeaderRow(rIdx)"
                                :class="['cursor-pointer hover:bg-blue-50', headerRowIndex === rIdx ? 'bg-blue-100 ring-2 ring-blue-500 z-10 relative' : '']">
                                <td class="bg-gray-100 text-gray-500 text-xs p-2 text-center font-bold">[[ rIdx + 1 ]]</td>
                                <td v-for="(cell, cIdx) in row" :key="cIdx" class="table-cell">[[ cell ]]</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-right">
                    <button @click="confirmHeader" :disabled="headerRowIndex === null" class="bg-blue-600 text-white px-6 py-2 rounded">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 3: æ˜ å°„ (å…³é”®ä¿®å¤ï¼švalue ç»‘å®š colIndex) -->
            <div v-if="step === 3" class="flex flex-col h-full p-6">
                <h2 class="text-lg font-bold mb-4">é…ç½®å­—æ®µæ˜ å°„</h2>
                <div class="bg-white p-6 rounded shadow grid grid-cols-2 gap-8 overflow-auto">
                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-700 border-b pb-2">æ ‡å‡†æ¨¡ç‰ˆå­—æ®µ</h3>
                        
                        <div v-for="(fieldLabel, fieldKey) in standardFields" :key="fieldKey" class="flex items-center justify-between">
                            <label class="text-sm font-medium" :class="['device_group','point_name'].includes(fieldKey) ? 'text-red-600': 'text-gray-600'">
                                [[ fieldLabel ]]
                            </label>
                            <!-- è¿™é‡Œçš„ value ç»‘å®šçš„æ˜¯ colIndex (0,1,2...)ï¼Œè¿™æ‰æ˜¯å”¯ä¸€çš„ï¼ -->
                            <select v-model="mapping[fieldKey]" class="border rounded p-2 w-72 text-sm font-mono">
                                <option :value="null">-- è¯·é€‰æ‹© --</option>
                                <option v-for="col in colOptions" :value="col.colIndex">
                                    [[ col.label ]]
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded text-sm text-gray-600">
                        <p>ğŸ’¡ ç°åœ¨ä¸‹æ‹‰æ¡†ç»‘å®šçš„æ˜¯<strong>åˆ—ç´¢å¼•</strong>ï¼Œå³ä½¿åˆ—åç›¸åŒæˆ–ä¸ºç©ºï¼Œä¹Ÿä¸ä¼šå†²çªäº†ã€‚</p>
                    </div>
                </div>
                <div class="mt-4 text-right">
                    <button @click="startTransform" class="bg-green-600 text-white px-6 py-2 rounded">å¼€å§‹è½¬æ¢</button>
                </div>
            </div>

            <!-- Step 4: å¯¹æ¯” -->
            <div v-if="step === 4" class="flex flex-col h-full p-4 overflow-hidden">
                <div class="flex h-full gap-4">
                    <div class="w-1/2 flex flex-col border rounded bg-white shadow">
                        <div class="p-2 bg-gray-100 border-b font-bold text-gray-600">å¤„ç†å‰ (Raw)</div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="p-2 text-left bg-gray-200">è®¾å¤‡ (åŸå§‹)</th>
                                        <th class="p-2 text-left bg-gray-200">æµ‹ç‚¹ (åŸå§‹)</th>
                                        <th class="p-2 text-left bg-gray-200">ä¿¡å·</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(row, idx) in transformResult.raw_data" :key="idx" class="border-b even:bg-gray-50">
                                        <td class="p-2 text-gray-400">[[ row.dev ]]</td>
                                        <td class="p-2 whitespace-pre-wrap">[[ row.pt ]]</td>
                                        <td class="p-2">[[ row.sig ]]</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="w-1/2 flex flex-col border rounded bg-white shadow ring-2 ring-green-500">
                        <div class="p-2 bg-green-50 border-b font-bold text-green-800">å¤„ç†å (Clean)</div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-green-50 sticky top-0">
                                    <tr>
                                        <th class="p-2 text-left">è®¾å¤‡ (Fill Down)</th>
                                        <th class="p-2 text-left">è‹±æ–‡ (Split)</th>
                                        <th class="p-2 text-left">ä¸­æ–‡ (Split)</th>
                                        <th class="p-2 text-left">ä¿¡å·</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(row, idx) in transformResult.clean_data" :key="idx" class="border-b even:bg-green-50">
                                        <td class="p-2 font-bold text-blue-600">[[ row.device_group ]]</td>
                                        <td class="p-2">[[ row.name_en ]]</td>
                                        <td class="p-2 text-gray-600">[[ row.name_zh ]]</td>
                                        <td class="p-2">[[ row.signal_type ]]</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button class="bg-gray-500 text-white px-6 py-2 rounded" @click="step=2">è¿”å›</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue

        const app = createApp({
            data() {
                return {
                    step: 1,
                    sheets: [],
                    currentSheet: '',
                    rawPreviewRows: [], 
                    maxCols: 0,
                    headerRowIndex: null, 
                    colOptions: [],
                    
                    standardFields: {
                        device_group: 'è®¾å¤‡ç»„/å (Fill Down)',
                        point_name: 'æ£€æµ‹ç‚¹åç§° (ä¸­è‹±æ‹†åˆ†)',
                        item_no: 'é¡¹ç›®ç¼–å·',
                        signal_type: 'ä¿¡å·ç±»å‹',
                        range: 'é‡ç¨‹',
                        unit: 'å•ä½'
                    },
                    mapping: {
                        device_group: null, point_name: null, item_no: null,
                        signal_type: null, range: null, unit: null
                    },
                    transformResult: { raw_data: [], clean_data: [] }
                }
            },
            methods: {
                getExcelColumnName(n) {
                    let ordA = 'A'.charCodeAt(0), ordZ = 'Z'.charCodeAt(0), len = ordZ - ordA + 1, s = "";
                    while(n >= 0) { s = String.fromCharCode(n % len + ordA) + s; n = Math.floor(n / len) - 1; }
                    return s;
                },
                async uploadFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const fd = new FormData(); fd.append('file', file);
                    const res = await fetch('/api/upload', { method: 'POST', body: fd });
                    const data = await res.json();
                    if (data.sheets) { this.sheets = data.sheets; this.step = 2; this.selectSheet(this.sheets[1]||this.sheets[0]); }
                },
                async selectSheet(s) {
                    this.currentSheet = s; this.headerRowIndex = null;
                    const res = await fetch('/api/preview_sheet', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sheet_name: s }) });
                    const data = await res.json(); this.rawPreviewRows = data.rows; this.maxCols = data.col_count;
                },
                selectHeaderRow(i) { this.headerRowIndex = i; },
                confirmHeader() {
                    const currentRow = this.rawPreviewRows[this.headerRowIndex];
                    const prevRow = this.headerRowIndex > 0 ? this.rawPreviewRows[this.headerRowIndex - 1] : null;
                    
                    this.colOptions = currentRow.map((cellVal, idx) => {
                        let labelVal = String(cellVal).trim();
                        // æ™ºèƒ½å‘ä¸ŠæŸ¥æ‰¾åˆå¹¶å•å…ƒæ ¼
                        if ((!labelVal || labelVal === 'nan') && prevRow) {
                            const prevVal = String(prevRow[idx]).trim();
                            if (prevVal && prevVal !== 'nan') labelVal = prevVal + " (ä¸Šè¡Œ)";
                        }
                        const colLetter = this.getExcelColumnName(idx);
                        return {
                            colIndex: idx, // å…³é”®ï¼šä½¿ç”¨ç´¢å¼•ä½œä¸º value
                            label: `[${colLetter}] ${labelVal}`
                        };
                    });
                    
                    // é‡ç½®æ˜ å°„
                    for(let k in this.mapping) this.mapping[k] = null;
                    this.autoMapColumns();
                    this.step = 3;
                },
                autoMapColumns() {
                    this.colOptions.forEach(opt => {
                        const txt = opt.label;
                        if (txt.includes('è®¾å¤‡ç»„') || txt.includes('EQUIPMENT')) this.mapping.device_group = opt.colIndex;
                        if (txt.includes('æ£€æµ‹ç‚¹') || txt.includes('ITEM NAME')) this.mapping.point_name = opt.colIndex;
                        if (txt.includes('é¡¹ç›®ç¼–å·') || txt.includes('ITEM NO')) this.mapping.item_no = opt.colIndex;
                        if (txt.includes('ä¿¡å·') || txt.includes('TYPE')) this.mapping.signal_type = opt.colIndex;
                        if (txt.includes('èŒƒå›´') || txt.includes('RANGE')) this.mapping.range = opt.colIndex;
                        if (txt.includes('å•ä½') || txt.includes('UNIT')) this.mapping.unit = opt.colIndex;
                    });
                },
                async startTransform() {
                    const res = await fetch('/api/transform', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
                        sheet_name: this.currentSheet, header_row_index: this.headerRowIndex, mapping: this.mapping
                    })});
                    const data = await res.json();
                    this.transformResult = data;
                    this.step = 4;
                }
            }
        })
        app.config.compilerOptions.delimiters = ['[[', ']]']
        app.mount('#app')
    </script>
</body>
</html>
