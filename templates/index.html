<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹è¡¨è½¬æ¢å‘å¯¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        .table-cell { @apply border px-2 py-1 text-xs whitespace-nowrap overflow-hidden text-ellipsis max-w-[150px]; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">
    <div id="app" class="flex flex-col h-full">
        <header class="bg-white shadow px-6 py-4 z-10">
            <h1 class="text-xl font-bold text-gray-800">â›´ï¸ èˆ¹èˆ¶ç‚¹è¡¨äº¤äº’å¼è½¬æ¢å‘å¯¼</h1>
            <div class="flex mt-4 space-x-8 text-sm font-medium">
                <div :class="step >= 1 ? 'text-blue-600' : 'text-gray-400'">1. ä¸Šä¼ æ–‡ä»¶</div>
                <div :class="step >= 2 ? 'text-blue-600' : 'text-gray-400'">2. é€‰æ‹© Sheet & è¡¨å¤´</div>
                <div :class="step >= 3 ? 'text-blue-600' : 'text-gray-400'">3. å»ºç«‹æ˜ å°„</div>
                <div :class="step >= 4 ? 'text-blue-600' : 'text-gray-400'">4. é¢„è§ˆ&è¡¥å…¨</div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative">
            <!-- Step 1: ä¸Šä¼  -->
            <div v-if="step === 1" class="flex items-center justify-center h-full">
                <div class="bg-white p-10 rounded-xl shadow-lg text-center">
                    <input type="file" @change="uploadFile" class="block w-full text-sm text-slate-500"/>
                </div>
            </div>

            <!-- Step 2: é€‰æ‹©è¡¨å¤´ -->
            <div v-if="step === 2" class="flex flex-col h-full p-6">
                <div class="flex space-x-2 mb-4 overflow-x-auto pb-2">
                    <button v-for="s in sheets" :key="s" @click="selectSheet(s)"
                        :class="['px-4 py-2 rounded-lg text-sm', currentSheet === s ? 'bg-blue-600 text-white' : 'bg-white hover:bg-gray-100']">
                        [[ s ]]
                    </button>
                </div>
                <div class="flex-1 overflow-auto bg-white rounded shadow border relative">
                    <table class="w-full">
                        <thead class="sticky top-0 bg-gray-200 z-20">
                            <tr>
                                <th class="w-10 text-xs p-1 border">#</th>
                                <th v-for="n in maxCols" :key="n" class="text-xs p-1 border text-center font-mono text-gray-500">
                                    [[ getExcelColumnName(n-1) ]]
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(row, rIdx) in rawPreviewRows" :key="rIdx" @click="selectHeaderRow(rIdx)"
                                :class="['cursor-pointer hover:bg-blue-50', headerRowIndex === rIdx ? 'bg-blue-100 ring-2 ring-blue-500 z-10 relative' : '']">
                                <td class="bg-gray-100 text-gray-500 text-xs p-2 text-center font-bold">[[ rIdx + 1 ]]</td>
                                <td v-for="(cell, cIdx) in row" :key="cIdx" class="table-cell">[[ cell ]]</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-right">
                    <button @click="confirmHeader" :disabled="headerRowIndex === null" class="bg-blue-600 text-white px-6 py-2 rounded">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 3: æ˜ å°„ -->
            <div v-if="step === 3" class="flex flex-col h-full p-6">
                <h2 class="text-lg font-bold mb-4">é…ç½®å­—æ®µæ˜ å°„</h2>
                <div class="bg-white p-6 rounded shadow grid grid-cols-2 gap-8 overflow-auto">
                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-700 border-b pb-2">æ ‡å‡†æ¨¡ç‰ˆå­—æ®µ</h3>

                        <div v-for="(fieldLabel, fieldKey) in standardFields" :key="fieldKey" class="flex items-center justify-between">
                            <label class="text-sm font-medium" :class="['device_group','point_name'].includes(fieldKey) ? 'text-red-600': 'text-gray-600'">
                                [[ fieldLabel ]]
                            </label>
                            <select v-model="mapping[fieldKey]" class="border rounded p-2 w-72 text-sm font-mono">
                                <option :value="null">-- è¯·é€‰æ‹© --</option>
                                <option v-for="col in colOptions" :value="col.colIndex">
                                    [[ col.label ]]
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded text-sm text-gray-600">
                        <p>ğŸ’¡ ç»‘å®šåˆ—ç´¢å¼•ä»¥é¿å…ç©ºè¡¨å¤´å†²çªï¼Œç¡®è®¤åå³å¯è¿›è¡Œè‡ªåŠ¨å¡«å……å’Œæ‹†åˆ†ã€‚</p>
                    </div>
                </div>
                <div class="mt-4 text-right">
                    <button @click="startTransform" class="bg-green-600 text-white px-6 py-2 rounded">å¼€å§‹è½¬æ¢</button>
                </div>
            </div>

            <!-- Step 4: é¢„è§ˆ/è¡¥å…¨/å¯¼å‡º -->
            <div v-if="step === 4" class="flex flex-col h-full p-4 overflow-hidden gap-4">
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded shadow col-span-2">
                        <h3 class="font-bold mb-2">èˆ¹åªä¿¡æ¯</h3>
                        <div class="grid grid-cols-3 gap-3 text-sm">
                            <label class="flex flex-col">èˆ¹åªåç§°<input v-model="shipInfo.name" class="border rounded p-1"/></label>
                            <label class="flex flex-col">èˆ¹åªç¼–å·<input v-model="shipInfo.hull" class="border rounded p-1"/></label>
                            <label class="flex flex-col">èˆ¹ä¸œ<input v-model="shipInfo.owner" class="border rounded p-1"/></label>
                            <label class="flex flex-col">é¡¹ç›®ç¼–å·<input v-model="shipInfo.project" class="border rounded p-1"/></label>
                            <label class="flex flex-col">èˆ¹çº§<input v-model="shipInfo.class" class="border rounded p-1"/></label>
                            <label class="flex flex-col">IMO<input v-model="shipInfo.imo" class="border rounded p-1"/></label>
                            <label class="flex flex-col">MMSI<input v-model="shipInfo.mmsi" class="border rounded p-1"/></label>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="font-bold mb-2">æ‰¹é‡èµ‹å€¼</h3>
                        <div class="flex gap-2 text-sm">
                            <select v-model="bulkField" class="border rounded p-1 flex-1">
                                <option value="">é€‰æ‹©åˆ—</option>
                                <option value="collect_type">é‡‡é›†ç±»å‹</option>
                                <option value="business_type">ä¸šåŠ¡ç±»å‹</option>
                                <option value="signal_type">ä¿¡å·ç±»å‹</option>
                            </select>
                            <input v-model="bulkValue" class="border rounded p-1 flex-1" placeholder="å¡«å……å€¼"/>
                            <button class="bg-blue-600 text-white px-3 rounded" @click="applyBulk">åº”ç”¨</button>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden bg-white rounded shadow border">
                    <div class="p-2 flex justify-between items-center bg-gray-50 border-b">
                        <div class="font-bold text-gray-700">åœ¨çº¿ç¼–è¾‘</div>
                        <div class="text-sm text-gray-500">å¯åœ¨å¯¼å‡ºå‰è¡¥å…… IPã€é‡‡é›†ç±»å‹ç­‰ç¼ºå¤±ä¿¡æ¯</div>
                    </div>
                    <div class="h-full overflow-auto">
                        <table class="w-full text-xs">
                            <thead class="sticky top-0 bg-gray-100">
                                <tr>
                                    <th class="p-2 border">è®¾å¤‡ç»„/å</th>
                                    <th class="p-2 border">é¡¹ç›®ç¼–å·</th>
                                    <th class="p-2 border">æ ‡å‡†åç§°</th>
                                    <th class="p-2 border">æ£€æµ‹ç‚¹EN</th>
                                    <th class="p-2 border">æ£€æµ‹ç‚¹ZH</th>
                                    <th class="p-2 border">ä¿¡å·ç±»å‹</th>
                                    <th class="p-2 border">ä¸šåŠ¡ç±»å‹</th>
                                    <th class="p-2 border">é‡‡é›†ç±»å‹</th>
                                    <th class="p-2 border">èŒƒå›´</th>
                                    <th class="p-2 border">å•ä½</th>
                                    <th class="p-2 border">IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(row, idx) in transformResult.clean_data" :key="idx" class="border-b">
                                    <td class="p-1 border"><input v-model="row.device_group" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.project_no" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.standard_name" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.name_en" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.name_zh" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.signal_type" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.business_type" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.collect_type" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.range" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.unit" class="w-full border rounded p-1"/></td>
                                    <td class="p-1 border"><input v-model="row.ip_address" class="w-full border rounded p-1"/></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">å…± [[ transformResult.clean_data.length ]] æ¡è®°å½•ã€‚</div>
                    <div class="space-x-3">
                        <button class="bg-gray-500 text-white px-4 py-2 rounded" @click="step=2">è¿”å›</button>
                        <button class="bg-green-600 text-white px-4 py-2 rounded" @click="exportExcel">å¯¼å‡ºæ ‡å‡†ç‚¹è¡¨</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue

        const app = createApp({
            data() {
                return {
                    step: 1,
                    sheets: [],
                    currentSheet: '',
                    rawPreviewRows: [],
                    maxCols: 0,
                    headerRowIndex: null,
                    colOptions: [],

                    standardFields: {
                        device_group: 'è®¾å¤‡ç»„/å (Fill Down)',
                        point_name: 'æ£€æµ‹ç‚¹åç§° (ä¸­è‹±æ‹†åˆ†)',
                        item_no: 'é¡¹ç›®ç¼–å·',
                        signal_type: 'ä¿¡å·ç±»å‹',
                        range: 'é‡ç¨‹',
                        unit: 'å•ä½',
                        alarm_type: 'æé™æŠ¥è­¦/ALARM'
                    },
                    mapping: {
                        device_group: null, point_name: null, item_no: null,
                        signal_type: null, range: null, unit: null, alarm_type: null
                    },
                    transformResult: { raw_data: [], clean_data: [] },
                    shipInfo: { name: '', hull: '', owner: '', project: '', class: '', imo: '', mmsi: '' },
                    bulkField: '',
                    bulkValue: ''
                }
            },
            methods: {
                getExcelColumnName(n) {
                    let ordA = 'A'.charCodeAt(0), ordZ = 'Z'.charCodeAt(0), len = ordZ - ordA + 1, s = "";
                    while(n >= 0) { s = String.fromCharCode(n % len + ordA) + s; n = Math.floor(n / len) - 1; }
                    return s;
                },
                async uploadFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const fd = new FormData(); fd.append('file', file);
                    const res = await fetch('/api/upload', { method: 'POST', body: fd });
                    const data = await res.json();
                    if (data.sheets) { this.sheets = data.sheets; this.step = 2; this.selectSheet(this.sheets[0]); }
                },
                async selectSheet(s) {
                    this.currentSheet = s; this.headerRowIndex = null;
                    const res = await fetch('/api/preview_sheet', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sheet_name: s }) });
                    const data = await res.json(); this.rawPreviewRows = data.rows; this.maxCols = data.col_count;
                },
                selectHeaderRow(i) { this.headerRowIndex = i; },
                confirmHeader() {
                    const currentRow = this.rawPreviewRows[this.headerRowIndex];
                    const prevRow = this.headerRowIndex > 0 ? this.rawPreviewRows[this.headerRowIndex - 1] : null;

                    this.colOptions = currentRow.map((cellVal, idx) => {
                        let labelVal = String(cellVal).trim();
                        if ((!labelVal || labelVal === 'nan') && prevRow) {
                            const prevVal = String(prevRow[idx]).trim();
                            if (prevVal && prevVal !== 'nan') labelVal = prevVal + " (ä¸Šè¡Œ)";
                        }
                        const colLetter = this.getExcelColumnName(idx);
                        return {
                            colIndex: idx,
                            label: `[${colLetter}] ${labelVal}`
                        };
                    });

                    for(let k in this.mapping) this.mapping[k] = null;
                    this.autoMapColumns();
                    this.step = 3;
                },
                autoMapColumns() {
                    this.colOptions.forEach(opt => {
                        const txt = opt.label;
                        if (txt.includes('è®¾å¤‡') || txt.includes('EQUIPMENT')) this.mapping.device_group = opt.colIndex;
                        if (txt.includes('æ£€æµ‹ç‚¹') || txt.includes('ITEM NAME')) this.mapping.point_name = opt.colIndex;
                        if (txt.includes('é¡¹ç›®ç¼–å·') || txt.includes('ITEM NO')) this.mapping.item_no = opt.colIndex;
                        if (txt.includes('ä¿¡å·') || txt.includes('TYPE')) this.mapping.signal_type = opt.colIndex;
                        if (txt.toLowerCase().includes('alarm')) this.mapping.alarm_type = opt.colIndex;
                        if (txt.includes('èŒƒå›´') || txt.includes('RANGE')) this.mapping.range = opt.colIndex;
                        if (txt.includes('å•ä½') || txt.includes('UNIT')) this.mapping.unit = opt.colIndex;
                    });
                },
                async startTransform() {
                    const res = await fetch('/api/transform', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
                        sheet_name: this.currentSheet, header_row_index: this.headerRowIndex, mapping: this.mapping
                    })});
                    const data = await res.json();
                    this.transformResult = data;
                    this.step = 4;
                },
                applyBulk() {
                    if (!this.bulkField || !this.bulkValue) return;
                    this.transformResult.clean_data.forEach(r => r[this.bulkField] = this.bulkValue);
                },
                async exportExcel() {
                    const res = await fetch('/api/export', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ rows: this.transformResult.clean_data, ship_info: this.shipInfo })
                    });
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url; a.download = 'standard_points.xlsx'; a.click();
                        window.URL.revokeObjectURL(url);
                    }
                }
            }
        })
        app.config.compilerOptions.delimiters = ['[[', ']]']
        app.mount('#app')
    </script>
</body>
</html>
