
---

# 项目需求文档 (PRD)：船舶点表智能化清洗与转换系统

## 1. 项目背景 & 目标
**核心痛点**：船厂提供的原始点表（Excel）格式不规范（存在合并单元格、多语言混合、表头混乱），而我司标准点表要求严格的结构化格式（包含船只信息、设备分组、设备列表及分Sheet的测点详情）。
**项目目标**：开发一个 Web 端导入向导，通过“上传 -> 映射 -> 清洗 -> 补全 -> 导出”的流程，将非标数据自动转换为我司标准 Excel 模版。

---

## 2. 数据结构定义

### 2.1 源数据（输入：船厂原始点表）
- 一般是由多Sheet 的 Excel 文件，
- 第一个sheet页是说明，包含简要的说明，
- 后面每个sheet页对应一个设备分组（船厂自定业务）
- 后面的每个sheet页中的内容是具体设备的和设备测点的信息，一般设备名称占用一列的一个cell，作为设备信息的开始，往右边的cols依次一个测点的所有属性，往下的行row也是改设备的测点，跟前面的测点属性列对齐
- 当测点顺序往下显示的时候，遇到空行，或者遇到设备名那一列出现新的设备名称，表名开始下一个设备的信息展示了

*   **格式**：非标 Excel (.xlsx)。
*   **特征**：
    *   **设备名缺失**：仅在设备出现的第一行显示，下方为空（需 Fill Down）。
    *   **字段混合**：中英文名称混在同一单元格（需 Split）。
    *   **多 Sheet**：通常按子系统（如“发电机”、“推进”）分Sheet存储。
    *   **信号类型**：原厂的描述一般为：模拟-ANALOGUE、开关-ON/OFF，
    *   - 在我司点表中药转为Analog或者Switch赋值到“信号类型”列中，
    *   - “模拟-ANALOGUE”有值情况则作为"DOUBLE"赋值到我司测点“数据类型”列中，“开关-ON/OFF”有值的情况作为"DOUBLE"赋值到我司测点“数据类型”列中
    *   - “模拟-ANALOGUE”有值情况 一般作为"DIGITAL"赋值到我司测点“业务类型”列中,“开关-ON/OFF”有值情况 一般作为"STATE"赋值到我司测点“业务类型”列中,如果“极限报警 ALARM”列存在“EA”、“L”、“H”等不为空的情况，我司测点“业务类型”列中需要赋值为“ALARM”
    *   **备注列**：备注REMARKS 列中一般为 我司点表的“采集類型”，直接赋值即可


### 2.2 目标数据（输出：我司标准点表）
输出文件为一个多 Sheet 的 Excel 文件，包含以下严格结构：

#### **Sheet 1: 说明 (索引页)**
包含三张表（逻辑上）：
1.  **船只信息 (ship_info)**:
    *   字段：`船只名称(Name)`, `船只编号(HULL No.)`, `船东(Owner)`, `项目编号(Project No.)`, `船级(Class)`, `IMO编号`, `MMSI编号`
2.  **设备分组 (equipment_group)**:
    *   字段：`ID`, `name_en`, `name_zh`, `alias`
3.  **设备列表 (equipment)**:
    *   字段：`id`, `name_en`, `name_zh`, `alias`, `类别`, `group_id`, `product_name`, `IP地址`

#### **Sheet 2 ~ N: 设备分组详情页**
*   **Sheet 命名**：对应设备分组名称（如“发电机组”、“推进系统”）。
*   **内容**：该分组下所有设备的测点列表。
*   **格式要求**：不同设备的测点之间，需插入**一个空行**作为间隔。
*   **字段列表**：
    *   `设备名`, `项目编号`, `标准名称`, `检测点名称(EN)`, `检测点名称(ZH/ITEM NAME)`, `别名`, `数据类型`, `信号类型`, `业务类型`, `报警类型`, `状态枚举`, `采集类型`, `关联测点`, `范围`, `单位`, `低低限`, `低限`, `高限`, `高高限`

---

## 3. 业务流程与功能需求

### 3.1 阶段一：导入与解析 (Import & Parse)
1.  **多 Sheet 识别**：上传文件后，列出所有 Sheet 供用户勾选（支持多选，因为船厂可能把不同系统放在不同 Sheet）。
2.  **智能表头定位**：
    *   用户点击某一行作为表头。
    *   **向上查找逻辑**：若用户选定行的某列为空（因合并单元格），自动读取上一行对应列的内容作为列名显示，避免“空列名”困惑。

### 3.2 阶段二：智能映射配置 (Mapping Configuration)
提供左右对照的映射界面。

#### **3.2.1 必选映射字段 (核心清洗)**
| 标准字段 | 处理逻辑 (后端 Pandas) |
| :--- | :--- |
| **设备名称** | **规则：Fill Down (向下填充)**。<br>读取该列，若当前行为空，则取上一行的值，直到遇到新值。 |
| **测点名称** | **规则：Split (拆分)**。<br>识别单元格内的换行符 `\n`。<br>- 第一行 -> `检测点名称(EN)`<br>- 第二行 -> `检测点名称(ZH)`<br>*(若无换行符，则中英填入相同内容)* |
| **项目编号** | 直接映射。 |
| **信号类型** | 直接映射。 |
| **范围/量程** | 直接映射。 |
| **单位** | 直接映射。 |

#### **3.2.2 可选映射字段**
*   提供 `数据类型`、`报警类型`、`低限`、`高限` 等字段的映射下拉框。若船厂表格中有对应列，则映射；若没有，留空进入下一阶段补全。

---

### 3.3 阶段三：数据预览、补全与编辑 (Data Enrichment) **[重点]**
由于船厂点表信息通常不全（例如缺 IP 地址、缺报警类型），转换后需提供**在线 Excel 风格编辑界面**。

#### **功能要求：**
1.  **船只信息录入表单**：
    *   在界面顶部提供表单，输入 `船只名称`, `项目编号`, `IMO` 等信息（用于生成 Sheet 1 的船只信息表）。
2.  **在线电子表格 (Grid Editor)**：
    *   展示清洗后的数据（已填充设备名、已拆分中英文）。
    *   **批量填充/编辑**：
        *   允许用户对某一列（如 `采集类型`）进行批量赋值（例如统选为 "Modbus"）。
        *   允许用户手动补全 `IP地址`（关联到设备层级）。
3.  **分组管理**：
    *   系统根据“设备名称”自动提取出设备列表。
    *   用户需指定（或系统自动归类）这些设备属于哪个 **分组**（对应标准点表的 Group Sheet）。
    *   *交互*：提供一个“设备 -> 分组”的分配界面。

---

### 3.4 阶段四：复杂结构导出 (Structure Export)
后端需根据整理好的数据，生成**严格符合我司标准**的 Excel。

#### **导出逻辑 (后端实现细节)**
1.  **生成 IDs**：为每个设备分组生成 `Group ID`，为每个设备生成 `Device ID`。
2.  **构建 Sheet 1 (说明)**：
    *   写入用户输入的船只信息。
    *   写入根据数据聚合出的“设备分组表”和“设备列表”。
3.  **构建 Group Sheets**：
    *   遍历每一个设备分组。
    *   创建一个新 Sheet，命名为分组名（如“发电机组”）。
    *   筛选出该分组下的所有设备及测点。
    *   **格式化写入**：
        *   写入表头。
        *   写入设备 A 的所有测点。
        *   **插入一个空行**。
        *   写入设备 B 的所有测点。
        *   *(循环直至该分组结束)*。

---

## 4. 关键技术实现逻辑 (伪代码 for Claude)

### 4.1 空值填充 (Fill Down)
```python
# df 为读取的原始 DataFrame
# device_col_idx 为用户映射的设备列索引
# ffill() 实现向下填充，infer_objects(copy=False) 避免新版 Pandas 警告
df.iloc[:, device_col_idx] = df.iloc[:, device_col_idx].infer_objects(copy=False).ffill()
```

### 4.2 文本拆分 (Split)
```python
def split_name(raw_text):
    if pd.isna(raw_text): return "", ""
    text = str(raw_text).strip()
    if '\n' in text:
        parts = text.split('\n')
        return parts[0].strip(), parts[1].strip() # EN, ZH
    return text, text # Fallback

# 应用到每一行
df[['point_en', 'point_zh']] = df.iloc[:, point_col_idx].apply(split_name, result_type='expand')
```

### 4.3 导出结构组装
```python
with pd.ExcelWriter('standard_output.xlsx') as writer:
    # 1. 写入 Sheet 1
    df_ship_info.to_excel(writer, sheet_name='说明', startrow=0)
    df_groups.to_excel(writer, sheet_name='说明', startrow=5) # 示例位置
    df_devices.to_excel(writer, sheet_name='说明', startrow=15)

    # 2. 写入各分组 Sheet
    for group_name, group_data in clean_data.groupby('group_name'):
        # 需要处理空行间隔逻辑
        final_rows = []
        for device_name, device_data in group_data.groupby('device_name'):
            final_rows.extend(device_data.to_dict('records'))
            final_rows.append({}) # 插入空行字典
        
        pd.DataFrame(final_rows).to_excel(writer, sheet_name=group_name, index=False)
```

---

## 5. 验收标准
1.  **填充验证**：导出文件中，所有测点行的“设备名”列必须有值，且归属正确（不再有空值）。
2.  **拆分验证**：中英文名称必须分列显示，且无乱码。
3.  **结构验证**：
    *   Sheet 1 包含三部分概览信息。
    *   后续 Sheet 按分组命名。
    *   同 Sheet 内不同设备间有空行分隔。
4.  **编辑验证**：在导出前，必须能在页面上把船厂没提供的“IP地址”或“业务类型”补全，并体现在导出文件中。

---

## 6. 建议技术栈
*   **后端**：Python (Flask/FastAPI) + Pandas + OpenPyXL/XlsxWriter (处理多Sheet和格式)。
*   **前端**：Vue 3 + Tailwind CSS + **Handsontable** (或类似的 Grid 库，用于实现 Excel 风格的在线编辑)。